---
title: "Susliks in Miroslav July 2019"
author: "Fernando Mateos-Gonzalez"
output:
  pdf_document: default
  html_document: default
  html_notebook: default
  word_document: default
---

This report analises data from capture-recapture sessions during 15-19 July 2019. The aim is to estimate population characteristics (mainly density) in Miroslav airport, to be able to extrapolate and apply to other areas of the Czech Republic.

We will follow the protocols described here
https://www.otago.ac.nz/density/

Useful links:
Example analysis
https://www.otago.ac.nz/density/pdfs/secr-tutorial.pdf


The following boxes include all the code and results to run the analyses in R. To install and run models in secr, you must download the package and load it. In the next box, we install and load the package secr, to do our analyses, and the package "here", to find files.


```{r results="hide"}
library(secr)
library(here)

```



Now we create the capthist, the file combining our captures with the trap locations:



```{r}

july <- read.capthist(here("data", "captures.txt"), here("data", "traps.txt"), detector = "proximity")

summary(july)
```

n number of distinct individuals detected on each occasion t
u number of individuals detected for the first time on each occasion t
f number of individuals detected on exactly t occasions
M(t+1) cumulative number of detected individuals on each occasion t



Now we use the plot method, which for capthist objects has additional arguments; we set tracks
= TRUE to join consecutive captures of each individual.
 (use arguments gridl and gridsp to suppress the grid or vary its spacing, and border to "zoom" in the area where the traps are).



```{r}
par(mar = c(1,1,1,1)) # reduce margins
plot (july, tracks = TRUE, gridsp = 5,border = 10)
      

```




The most important insight from this figure is that individuals tend to be recaptured near their site of first
capture. This is expected when the individuals of a species occupy home ranges. In SECR models the
tendency for detections to be localised is reflected in the spatial scale parameter σ. Good estimation of σ and
density D requires spatial recaptures (i.e. captures at sites other than the site of first capture).

Successive trap-revealed movements can be extracted with the moves function and summarised with hist:


```{r}
m <- unlist(moves(july))
par(mar = c(3.2,4,1,1), mgp = c(2.1,0.6,0)) # reduce margins
hist(m, breaks = seq(0/2, 30,2), xlab = "Movement m", main = "")
```

The function RPSV with option CC = TRUE provides a biased estimate of the spatial scale σ, ignoring the
problem that movements are truncated by the edge of the grid:



```{r}
initialsigma <- RPSV(july, CC = TRUE)
cat("Quick and biased estimate of sigma =", initialsigma, "m\n")
```


This estimate will be useful when we come to fit a model.


Next we fit the simplest possible SECR model with function secr.fit. Setting trace = FALSE suppresses
printing of intermediate likelihood evaluations; it doesn’t hurt to leave it out. We save the fitted model with
the name ‘fit’.

To examine model output or extract particular results you should use one of the functions defined for the
purpose. Technically, these are S3 methods for the class ‘secr’. The key methods are print, plot, AIC, coef,
vcov and predict. Append ‘.secr’ when seeking help e.g. ?print.secr.
Typing the name of the fitted model at the R prompt invokes the print method for secr objects and displays
a more useful report.


```{r}
fit <- secr.fit (july, buffer = 4 * initialsigma, trace = FALSE,biasLimit = NA, verify = FALSE)

detector(traps(july)) <- "proximity"

fit
```


The report comprises these sections that you should identify:
• function call and time stamp
• summary of the data
• description of the model, including the maximized log likelihood, Akaike’s Information Criterion AIC
• estimates of model coefficients (beta parameters)
• estimates of variance-covariance matrix of the coefficients
• estimates of the ‘real’ parameters

The last three items are generated by the coef, vcov and predict methods respectively. The final table of
estimates is the most interesting, but it is derived from the other two. For our simple model there is one beta
parameter for each real parameter (We can get from beta parameter estimates to real parameter estimates by applying the inverse of the link function e.g.: Dˆ = exp(βˆD), and similarly for confidence limits; standard errors require a delta-method approximation (Lebreton et al. 1992).)

. The estimated density is 260 susliks per hectare, 95% confidence interval 175-384 susliks per hectare
. The other two real parameters jointly determine the detection function that you can easily plot with 95% confidence limits




```{r}
par(mar = c(4,4,1,1)) # reduce margins
plot(fit, limits = TRUE)


```




The theory of SECR tells us that buffer width is not critical as long as it is wide enough that animals at
the edge have effectively zero chance of appearing in our sample. The 4 suggestion is based on experience
with half-normal detection models7. We check that for the present model with the function esa.plot. The
estimated density8 has easily reached a plateau at the chosen buffer width (dashed red line):



```{r}
esa.plot(fit)
abline(v = 4 * initialsigma, lty = 2, col = 'red')

```

## Choosing a detection function

• detection probability declines with distance according to a half-normal curve

We can try alternative shapes for the detection function (the decline in detection probability with distance).
secr offers several different shapes of detection function (see the list at ?detectfn). We need to sort these
out. All except ANN and HAN decline monotonically with distance. Three are only used for acoustic data
(BSS, SS, SSS). The simplest UN is not available for maximum likelihood model fitting, and several are
frankly exotic and almost never used (CHN, WEX, CLN, CG), as are ANN and HAN.

That leaves the half-normal, negative exponential, and hazard rate functions (HN, EX, HR) These differ
primarily in the length of their tails i.e. the probability they assign to very distant detections. The half-normal
makes distant detections very improbable, the negative exponential less so; The ‘hazard-rate’ function requires
a third parameter and potentially has a very long tail indeed.
Fit each of these and assess the effect. We use a wider buffer to allow for longer tails



```{r}
fit.HN <- secr.fit (july, buffer = 6 * initialsigma, detectfn = 'HN', trace = FALSE, biasLimit = NA,verify = FALSE)
fit.EX <- secr.fit (july, buffer = 6 * initialsigma, detectfn = 'EX', trace = FALSE, biasLimit = NA,verify = FALSE)
fit.HR <- secr.fit (july, buffer = 6 * initialsigma, detectfn = 'HR', trace = FALSE, biasLimit = NA,verify = FALSE)

fits <- secrlist(HN = fit.HN, EX = fit.EX, HR = fit.HR)
predict(fits)
```
When everything is done, we upload it to github following
https://happygitwithr.com/existing-github-first.html
